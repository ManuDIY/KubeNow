#!/bin/bash

# Exit immediately if a command exits with a non-zero status
set -e

# Read config file into variable as as json
kn_config=$(json2hcl -reverse <config.tfvars)

# Set variables from json-config
host_cloud=$(jq -r '.provider' <<<"$kn_config")

image_name=$(jq -r '.boot_image' <<<"$kn_config")
if [[ "$image_name" != "null" ]]; then
  KN_IMAGE_NAME="$image_name"
fi

image_url=$(jq -r '.image_url' <<<"$kn_config")
if [[ "$image_url" != "null" ]]; then
  KN_IMAGE_BUCKET_URL="$image_url"
fi

skip_image_import=$(jq -r '.skip_image_import' <<<"$kn_config")

# Run preflight-check if file is specified
preflight_script=$(jq -r '.preflight_script' <<<"$kn_config")
if [ -z "$preflight_script" ]; then
  "$preflight_script" config.tfvars
fi

# Check for recognized cloud provider
if ! grep -qw "$host_cloud" <<<"openstack gce azure aws kvm"; then
  echo >&2 "Error: unrecognized host cloud '$host_cloud' in config file config.tfvars"
  exit 1
fi

# Import image (AWS doesn't need it)
if [[ "$skip_image_import" != "true" ]] && [[ "$host_cloud" != 'aws' ]]; then
  export KN_GCE_ACCOUNT_FILE_PATH="$PWD/service-account.json"
  export TF_VARS_FILE="$PWD/config.tfvars"
  export KN_IMAGE_NAME
  export KN_IMAGE_BUCKET_URL
  echo $$KN_IMAGE_BUCKET_URL=KN_IMAGE_BUCKET_URL
  /KubeNow_root/bin/image-create-"$host_cloud".sh
fi

# Deploy
terraform init --plugin-dir=/terraform_plugins "/KubeNow_root/$host_cloud"

# shellcheck disable=SC2086
terraform apply $TERRAFORM_OPT -var-file=config.tfvars "/KubeNow_root/$host_cloud"

# Provision
/KubeNow_root/bin/kn-provision
